name: CI

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
        - name: Set up QEMU
          uses: docker/setup-qemu-action@v3

        - run: |
            podman machine init
            podman machine set --rootful
    
        - uses: actions/checkout@v5

        - run: podman build -t bootc .

        - run: |
            podman run \
                --rm \
                -it \
                --privileged \
                --pull=newer \
                --security-opt label=type:unconfined_t \
                -v ./config.toml:/config.toml:ro \
                -v ./output:/output \
                -v /var/lib/containers/storage:/var/lib/containers/storage \
                quay.io/centos-bootc/bootc-image-builder:latest \
                --type anaconda-iso \
                --use-librepo=True \
                localhost/test-bootc:latest --rootfs xfs

        - run: ls -lah output